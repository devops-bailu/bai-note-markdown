# 架构的发展

## 架构的发展总揽

架构的发展总结为以下几个阶段：单体应用架构、垂直应用架构、SOA架构、微服务架构、服务网格

在架构历史的发展历程中，有以下比较明显的现象：

1. 为了解决单体应用不够灵活的问题，引入了分布式架构
2. 在分布式的基础架构下，衍生出了上层应用架构-微服务架构
3. 为了解决微服务架构下大量应用部署的问题，引入了容器
4. 为了解决容器的管理和调度问题，引入了 Kubernetes
5. 为了解决微服务框架的侵入性问题，引入了 Service Mesh
6. 为了让 Service Mesh 有更好的底层支撑，又将 Service Mesh 运行在了 Kubernetes 上

在这个过程中，从单个应用（或者微服务）的角度看，的确自身的复杂度降低，在有底层系统支撑的情况下部署、维护、管理、控制、监控等也都大为简化。但是站在整个系统的角度，整体复杂度并没有消失，只是从单体分解到微服务，从应用下沉到 Service Mesh，复杂度从总量上不但没有减少，反而大为增加。

对于中小型业务公司来说，解决这个问题最好的方式就是上云，使用托管版本的 Kubernete 和 Service Mesh，从而将底层系统的复杂度交给云厂商，而客户只需要在云的基础上享受 Service Mesh 技术带来的使用便利和强大功能。

对于大型业务公司来说，可以采用自建或者托管k8s的方式相结合，在实现业务的基础上，可以逐步发展底层系统的解决方案，根据业务具体情况，可以选择关注业务，或者是同时关注业务与底层系统的发展。

对于云厂商来说，需要解决底层系统的复杂度，以及需要大幅度下沉系统感知度，提供完善的各类工具，让客户只需要关注具体业务实现即可。

## 单体架构

单体架构就是一个归档包，包含了应用所有的功能的应用程序，部署在一个服务器或多个上，通常称之为单体应用，是比较传统的单体架构。

我们常说的一些web框架，比如说 Django、Flask、Gin、Beego等等，都是基于我们说的经典的3层模型，即表现层、业务逻辑层、数据访问层，也即`MVC`架构，就是常见的单体架构思想的一种表现形式。

#### 单体架构的优缺点

###### 1. 优点

- 部署简单：由于是完整的结构体，可以直接部署在一个服务器上即可

- 技术单一：项目不需要复杂的技术栈，往往一套熟悉的技术栈就可以完成开发
- 用人成本低：单个程序员可以完成业务接口到数据库的整个流程

###### 2. 缺点

- 复杂度高：整个项目包含的模块非常多，模块的边界模糊，依赖关系不清晰，代码质量参差不齐，整个项目非常复杂。每次修改代码、添加功能，或者修改一个BUG都可能会造成隐含的缺陷
- 技术债务大：随着时间推移、需求变更和人员更迭，会逐渐形成应用程序的技术债务，并且越积越多。已使用的系统设计或代码难以修改，因为应用程序的其他模块可能会以意料之外的方式使用它
- 可扩展能力差：无法按需伸缩，单体应用只能作为一个整体进行扩展，无法结合业务模块的特点进行伸缩
- 创新能力差：  单体应用往往使用统一的技术平台或方案解决所有问题，团队的每个成员都必须使用相同的开发语言和架构，想要引入新的框架或技术平台非常困难
- 交付周期长，所有功能需要一起上线，一起构建，一起部署

## 从单体架构到分布式架构到微服务架构的演进

#### 一、单体应用架构

###### 1. 单体应用架构

​		只需要一个应用，将所有的功能代码打包成一个服务，部署到服务器上就能支撑业务

![](https://bai-images-1258524516.cos.ap-beijing.myqcloud.com//markdown202204071824894.png)

###### 2. 应用和数据库分离

​		随着访问量的上升，负载变高，单台机器遇到了性能瓶颈，增加机器将应用和数据库拆分，这样不仅提高了负载能力，而且将数据和应用分离部署也提高了容灾能力

![](https://bai-images-1258524516.cos.ap-beijing.myqcloud.com//markdown202204081343470.png)

###### 3. 应用集群化

​		访问量还在持续增加的时候，需要将应用服务器集群化，将请求分流到多个应用服务器中达到提升负载能力的目的，这样多个应用服务器之间没有直接交互，而是依赖于数据库各自对外提供服务

![](https://bai-images-1258524516.cos.ap-beijing.myqcloud.com//markdown202204081347394.png)

###### 4. 垂直应用架构

​		随着业务的发展，单体应用无法支撑业务的发展，会将业务系统按照应用拆分，拆分为几个互不想干的应用，以此来提升整个业务系统的能力

​		垂直应用架构对系统进行了拆分，可根据不同系统的访问情况，有针对性的进行优化；能够实现应用的水平扩展；各系统能够分担整体访问的流量，解决了并发问题；一个系统发生了故障，不应用其他系统的运行情况，提高了整体的容错率

​		但是垂直应用架构拆分后的各系统之间相对比较独立，无法进行互相调用；各系统难免存在重叠的业务，会存在重复开发的业务，后期维护比较困难

![](https://bai-images-1258524516.cos.ap-beijing.myqcloud.com//markdown202204081407655.png)

###### 5. 分布式架构

​		当垂直应用系统越来越多，重复编写的业务代码就会越来越多。此时，就会将重复的代码抽象出来，形成统一的服务供其他系统或者业务模块来进行调用。系统就会演变为分布式架构。 在分布式架构中，我们会将系统整体拆分为服务层和表现层。服务层封装了具体的业务逻辑供表现层调用，表现层则负责处理与页面的交互操作

​		分布式架构将重复的业务代码抽象出来，形成公共的访问服务，提高了代码的复用性；可以有针对性的对系统和服务进行优化，提升整体系统性能

​		但是分布式架构系统之间的耦合度变高，调用关系变得复杂，难以维护

![](https://bai-images-1258524516.cos.ap-beijing.myqcloud.com//markdown202204081433137.png)

###### 6. SOA架构

​		在分布式架构下，当部署的服务越来越多，重复的代码就会越来越多，对于容量的评估，小服务资源的浪费等问题比较严重。此时，我们就需要增加一个统一的调度中心来对集群进行实时管理。此时，系统就会演变为SOA `Service-Oriented Architecture`（面向服务）的架构

​		SOA架构使用ESB解决了各个服务之间的服务依赖和调用关系的自动注册与发现

​		但是SOA架构各服务之间存在依赖关系，如果某个服务出现故障可能会造成服务的大面积雪崩；服务之间的依赖与调用关系复杂，测试部署的困难比较大		![](https://bai-images-1258524516.cos.ap-beijing.myqcloud.com//markdown202204081505888.png)

###### 6. 微服务架构

​		微服务在SOA架构的基础上进一步扩展，将其彻底拆分为微服务架构。在微服务架构下，我们将一个大的项目拆分为一个个小的功能模块，这些功能模块都可以独立部署，每个微服务都有自己的数据库

​		微服务架构服务彻底拆分，各服务独立打包、独立部署和独立升级；每个微服务负责的业务比较清晰，利于后期扩展和维护；微服务之间可以采用REST和RPC协议进行通信

​		微服务架构开发的成本比较高；涉及到各服务的容错性问题；涉及到数据的一致性问题；涉及到分布式事务问题

![](https://bai-images-1258524516.cos.ap-beijing.myqcloud.com//markdown202204081520047.png)

## 分布式架构

简单的说，"分工协作，专人做专事"就是分布式的概念，"大系统小做"，大系统小做对于一个大的复杂系统，对其分拆，拆成多个子系统

#### 分布式架构的优缺点

###### 1. 优点：

1. 易于扩展：业务量越来越大，而要能应对越来越大的业务量，一台机器的性能已经无法满足了，需要多台机器才能应对大规模的应用场景，方便垂直或是水平进行扩展

2. 系统可用性：业务越来越关键，需要提高整个系统架构的可用性，这就意味着架构中不能存在单点故障。整个系统不会因为一台机器出故障而导致整体不可用。分布式架构来冗余系统可以消除单点故障，从而提高系统的可用性

3. 便于因为软件服务模块被拆分，开发和发布速度可以并行而变得更快

4. 系统扩展性更高

5. 团队协作流程也会得到改善

###### 2. 缺点：

1. 架构设计变得复杂（尤其是其中的分布式事务）

2. 部署单个服务会比较快，但是如果一次部署需要多个服务，部署会变得复杂

3. 系统的吞吐量会变大，但是响应时间会变长

4. 运维复杂度会因为服务变多而变得很复杂

5. 架构复杂导致学习曲线变大

6. 测试和查错的复杂度增大

7. 技术可以很多样，这会带来维护和运维的复杂度

8. 管理分布式系统中的服务和调度变得困难和复杂

## 微服务架构

微服务架构（Microservice Architecture）是一种架构概念，旨在通过将功能分解到各个离散的服务中以实现对解决方案的解耦。你可以将其看作是在架构层次而非获取服务的层次

微服务的设计目的是为了让大型软件系统解耦。将不同职责的服务独立部署，从而实现服务内部高内聚，服务之间低耦合的效果，让开发变得更为灵活

## 微服务架构

**官方的定义：**

1. 一些列的独立的服务共同组成系统

2. 单独部署，跑在自己的进程中

3. 每个服务为独立的业务开发

4. 分布式管理

5. 强调隔离性

**大概的标准：**

1. 分布式服务组成的系统

2. 按照业务，而不是技术来划分组织

3. 做有生命的产品而不是项目

4. 强服务个体和弱通信（ Smart endpoints and dumb pipes ）

5. 自动化运维（ DevOps ）

6. 高度容错性

7. 快速演化和迭代



